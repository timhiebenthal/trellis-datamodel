## Data model file evolution and schema synchronization

This project does NOT use traditional database migrations. Instead, it manages two-way synchronization between conceptual data models (YAML files) and physical dbt implementations.

### Data Flow Architecture
1. **Read**: dbt artifacts (manifest.json, catalog.json) → understand physical implementation
2. **Store**: Conceptual model in `data_model.yml` → entity definitions and relationships
3. **Store**: Visual layout in `canvas_layout.yml` → canvas positions and visual properties
4. **Write**: Back to dbt `schema.yml` → descriptions, tags, relationship tests

### data_model.yml Evolution
- **Version Control**: Always commit `data_model.yml` changes to version control
- **File Structure**: Maintain consistent YAML structure (version, entities, relationships)
- **Backward Compatibility**: When changing data model schema, consider migration path for existing files
- **Validation**: Validate structure after modifications to ensure consistency
- **No Visual Properties**: Keep visual/layout properties in separate `canvas_layout.yml` file

### canvas_layout.yml Management
- **Purpose**: Stores canvas-specific visual properties (positions, sizes, collapsed states)
- **Separation**: Keep visual properties separate from business logic in `data_model.yml`
- **Auto-Generated**: Created automatically when saving from canvas; can be safely deleted to reset layout
- **Git Tracking**: Consider whether to track in git (personal preference vs. team shared layouts)

### Writing to dbt schema.yml Files
- **Preserve Formatting**: Use `ruamel.yaml` to preserve YAML structure, comments, and formatting when updating dbt schema files
- **Atomic Updates**: Read, modify, and write schema.yml files atomically to avoid corruption
- **Selective Updates**: Only update specific fields (descriptions, tags, tests) without rewriting entire file
- **Test Generation**: Auto-generate dbt `relationships` tests from data model relationships
- **Incremental Changes**: Make incremental updates rather than rewriting entire schema files

### Synchronization Patterns
- **Greenfield**: Draft entities/fields in canvas → generate schema.yml for dbt
- **Brownfield**: Load existing dbt models from manifest → document relationships in canvas → write tests back to schema.yml
- **Bidirectional**: Changes in either direction (canvas → dbt or dbt → canvas) should be handled gracefully

### File Locations
- **data_model.yml**: Configurable via `data_model_file` in `trellis.yml`, typically in dbt project root
- **canvas_layout.yml**: Automatically placed next to `data_model.yml`
- **dbt schema.yml**: Located in dbt model directories (e.g., `models/3_core/schema.yml`)

### Never Modify These Files Directly
- **manifest.json**: Generated by `dbt docs generate`, read-only for Trellis
- **catalog.json**: Generated by `dbt docs generate`, read-only for Trellis
